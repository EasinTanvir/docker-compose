name: Local Auto Deploy

on:
    push:
        branches:
            - main

jobs:
    rebuild-and-restart:
        runs-on: self-hosted
        steps:
            - name: Checkout latest code
              uses: actions/checkout@v4

            - name: Rebuild and restart containers (no downtime)
              run: |
                  echo "🔄 Pulling latest code..."
                  git fetch origin main
                  git reset --hard origin/main

                  echo "⚙️ Rebuilding containers safely..."
                  docker compose -p prodapp build

                  echo "🚀 Starting updated containers..."
                  docker compose -p prodapp up -d --remove-orphans

                  echo "✅ Deployment complete."
